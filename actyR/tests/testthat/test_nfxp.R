set.seed(12345)

# Include required packages
library("actyR")

# Make the Gauss-Legendre integration nodes and weights
GaussLegendre = legendre.quadrature.rules(32)[32][[1]]

# Set Settings
Settings = list(
    tolInner = 1e-10,
    maxIterInner = 1000,
    nCheck = 5,
    cCheck = 50,
    lowBndC = 0.5,
    uppBndC = 5,
    logGrid = NA,
    d = NA,
    integrationNodes = (GaussLegendre$x + 1) / 2,
    integrationWeights = GaussLegendre$w / 2
)

# Make a grid of the population data
Settings$logGrid = matrix(seq(log(Settings$lowBndC),log(Settings$uppBndC), length.out =
                                  Settings$cCheck), nrow = 1, ncol = Settings$cCheck)
Settings$d = Settings$logGrid[2] - Settings$logGrid[1]

# We now define the true values for which we have a simulated dataset
Param = list(
    rho = 1 / 1.05,
    k = c(1.8, 1.4, 1.2, 1, 0.9),
    phi = rep(10,5),
    omega = 1.0,
    mu = 0,
    sigma = 2,
    Pi = NA,
    kappa = 1
)


truth = c(1.8, 1.4, 1.2, 1, 0.9, 10, 1, 0, 2)

specificationMatrix = matrix(0 , nrow = 10 + 3, ncol = 9)
specificationMatrix[1:5,1:5] = diag(rep(1,5), nrow = 5, ncol = 5)
specificationMatrix[6:10,6] = rep(1,5)
specificationMatrix[11,7] = 1
specificationMatrix[12,8] = 1
specificationMatrix[13,9] = 1
if ("specificationMatrix" %in% names(Param)) {
    Param$specificationMatrix = specificationMatrix
} else {
    Param = c(Param, list(specificationMatrix = specificationMatrix))
}


# Compute the transition probability matrix at the truth
Param$Pi = tauchen(Settings$logGrid, Param$mu, Param$sigma)

# Compute the value function and check how long it takes
ret  = valuefunction(Settings, Param)

test_that("check value function", {
    expect_true(sum(abs(ret$vS - structure(
        c(
            2.0791696718293, 0.385906446112523, 0.200633217348978,
            0.121682389097145, 0.0868247049720602, 0, 2.27258814098678, 0.405996464795096,
            0.209873927089741, 0.127019180885423, 0.0905667573671112, 0,
            2.57796377880926, 0.431244172495516, 0.221065789830366, 0.133395694878733,
            0.0950165331785606, 0, 2.96529992289953, 0.45879354987846, 0.232988048273262,
            0.140127631265261, 0.0996986989115001, 0, 3.42874261870002, 0.488746256525519,
            0.245675207561699, 0.147232327471639, 0.104624454022486, 0, 3.96493707518217,
            0.521392793007999, 0.259191635000859, 0.154734847012677, 0.10980832807306,
            0, 4.56644961298714, 0.557082551761414, 0.273609596389491, 0.162662533219736,
            0.115265968287699, 0, 5.22028469163476, 0.59622737957029, 0.28900988849498,
            0.171045217194008, 0.121014239342549, 0, 5.90853979067073, 0.639315053482066,
            0.30548311528395, 0.179915508721297, 0.127071346749849, 0, 6.60988394925783,
            0.686926878874624, 0.323131211440321, 0.189309129158046, 0.133456975565052,
            0, 7.30113731447498, 0.739760113059632, 0.342069255704036, 0.199265292880085,
            0.140192446589211, 0, 7.95865531549012, 0.798656569525206, 0.362427638982977,
            0.209827145699051, 0.147300892670593, 0, 8.55951870139361, 0.864639076769271,
            0.384354669258325, 0.221042270350643, 0.154807458165119, 0, 9.08266601499515,
            0.938957637364035, 0.408019717004887, 0.232963271242101, 0.162739525162604,
            0, 9.51011048057181, 1.02314682462583, 0.433617032876061, 0.245648453217168,
            0.171126970746073, 0, 9.82831640647141, 1.1190943184581, 0.461370405696027,
            0.259162612282205, 0.180002460351255, 0, 10.0297148264121, 1.229115701629,
            0.491538875835751, 0.273577960199899, 0.189401783266123, 0, 10.1142342391238,
            1.35601945151262, 0.52442377991115, 0.288975209806627, 0.199364237498462,
            0, 10.0906088630807, 1.50312428581782, 0.560377481083626, 0.305444854115888,
            0.209933072697398, 0, 9.97709066114694, 1.67415743454173, 0.599814238933628,
            0.323088680081263, 0.221156001611988, 0, 9.80103969367884, 1.87292830752467,
            0.643223796913672, 0.342021567756843, 0.233085792796682, 0, 9.59679845001137,
            2.10267205857459, 0.691188413089112, 0.362373638087661, 0.245780960046444,
            0, 9.40150546480977, 2.36504262676872, 0.744404220194955, 0.384292828424587,
            0.259306567516629, 0, 9.24928689595017, 2.65892462722602, 0.803707937160293,
            0.407947995019855, 0.273735173855669, 0, 9.16536248960209, 2.97945131496497,
            0.870109969125584, 0.433532667377894, 0.28914794421902, 0, 9.16218475942811,
            3.31769865845108, 0.944834595029875, 0.461269611801219, 0.30563596609705,
            0, 9.239051454277, 3.66136092637859, 1.02936673657203, 0.491416402351083,
            0.323301813956949, 0, 9.38502038087589, 3.99637371207364, 1.12550167973864,
            0.524272248288192, 0.342261419419442, 0, 9.58362080501353, 4.30914036613733,
            1.23538720974566, 0.560186388891435, 0.36264631895462, 0, 9.81759402621678,
            4.58888180893431, 1.36153435947252, 0.599568438681004, 0.384606371114799,
            0, 10.0724657772979, 4.82964991600269, 1.50675185206172, 0.642901143510098,
            0.40831306183617, 0, 10.3384824324105, 5.03161238329288, 1.67393494033334,
            0.690756075980334, 0.433963551741631, 0, 10.6109557047889, 5.20126353735024,
            1.86563014155343, 0.743812821293526, 0.461785667086682, 0, 10.8893671877989,
            5.35028953953616, 2.08333735677649, 0.802882101905579, 0.492044100930917,
            0, 11.1757870204124, 5.4930606876353, 2.32662877963343, 0.868932891889046,
            0.525048180453012, 0, 11.4732298984256, 5.64322181939497, 2.59233700317885,
            0.943122539704994, 0.561161680616956, 0, 11.7844039001366, 5.81041506637576,
            2.87419071663726, 1.02682661622642, 0.600815339417871, 0, 12.1109782919606,
            5.9983457547309, 3.16323026894037, 1.12166059037151, 0.644522979580739,
            0, 12.4532886187016, 6.20489556328561, 3.44908875058697, 1.22947720042621,
            0.692902502439278, 0, 12.810435830802, 6.42406065720355, 3.72189343672609,
            1.35231099208379, 0.746703547443888, 0, 13.1807933513478, 6.64876308081487,
            3.97429121463937, 1.49222797067635, 0.806844382845547, 0, 13.5627994878101,
            6.87342370391757, 4.20301508307988, 1.65103473710342, 0.874461666781937,
            0, 13.955707371593, 7.09549695632547, 4.40948469909042, 1.82982879367753,
            0.950977816127973, 0, 14.3599420020959, 7.31566624665594, 4.599165504368,
            2.02845010759566, 1.03818961208024, 0, 14.7769292245299, 7.53689618186376,
            4.7798131820972, 2.2450125929369, 1.13836729629625, 0, 15.2085639962255,
            7.76294204217711, 4.95923455374852, 2.47577067773022, 1.254281377744,
            0, 15.6567126992169, 7.99711638303203, 5.14351293671988, 2.71540945714432,
            1.38879476621694, 0, 16.123230614212, 8.24180771311733, 5.33611933065734,
            2.95692731568376, 1.54274382117418, 0, 16.6086359681542, 8.49605496009822,
            5.53465322210308, 3.18690426417019, 1.70723683733186, 0, 17.043687075536,
            8.7176081806102, 5.70166070287857, 3.35975515061027, 1.83961986443651,
            0
        ), .Dim = c(6L, 50L)
    ))) < 1e-6)
})

# Simulate data set
Data = simulateData(Settings, Param, rCheck = 100, tCheck = 10)

# Pick some start values
Startvalues.step1 = c(0,2)

# Do the optimization
Step1.Estimates = optim(
    Startvalues.step1,
    nfxpLikelihoodStep1,
    nfxpGradientStep1,
    method = "BFGS",
    control = list(
        REPORT = 1, abstol = 1e-8, reltol = 1e-8, maxit = 1000, trace = 1
    ),
    Data = Data, Settings = Settings
)$par


Param$Pi = tauchen(Settings$logGrid, Step1.Estimates[1], Step1.Estimates[2])

# Randomly choose starting values for the second step
Startvalues.Step2 = matrix(runif (1, 0, 5), nrow = 1, ncol = length(truth) -
                               2)
while (!is.finite(nfxpLikelihoodStep2(Startvalues.Step2, Data = Data, Settings = Settings, Param = Param))) {
    Startvalues.Step2 = matrix(runif (1, 0, 5), nrow = 1, ncol = length(truth) - 2)
}

# Do the optimization
Step2.Estimates  = optim(
    par = Startvalues.Step2,
    fn  = nfxpLikelihoodStep2,
    gr  = nfxpGradientStep2,
    method = "BFGS",
    control = list(
        REPORT = 1,
        abstol = 1e-8,
        reltol = 1e-8,
        maxit = 1000,
        trace = 1
    ),
    Data = Data,
    Settings = Settings,
    Param = Param
)$par


# Take the estimates from step 1 and step 2 as startvalues
Startvalues.step3 = c(Step2.Estimates, Step1.Estimates)

Step3.Estimates  = optim(
    Startvalues.step3,
    nfxpLikelihoodStep3,
    nfxpGradientStep3,
    method = "BFGS",
    control = list(
        REPORT = 1, abstol = 1e-8, reltol = 1e-8, maxit = 1000, trace = 1
    ), Data = Data, Settings = Settings, Param = Param
)$par

Step3.Covariance = nfxpCovarianceStep3(Step3.Estimates, Data = Data, Settings =
                                             Settings, Param = Param)
Step3.StandardErrors = sqrt(diag(Step3.Covariance))

test_that("Check Step 1 Estimates", {
    expect_true(sum(abs(
        Step1.Estimates - c(0.114369712235099, 2.09343044077646)
    )) < 1e-6)
})

test_that("Check Step 2 Standard Errors", {
    expect_true(sum(abs(
        Step2.Estimates - c(1.84579340491419, 1.34218854152882, 1.17633787462393,
                            1.07110387250079, 0.998611500987109, 7.21017648935396, 0.856127368428666)
    )) < 1e-6)
})

test_that("Check Step 3 Estimates", {
    expect_true(sum(abs(
        Step3.Estimates - c(1.84679107054471, 1.34224875426285, 1.17656354056988, 1.07131965400452,
          0.998803738221509, 7.210140777222, 0.856231766114263, 0.109717816151898,
          2.09431951788949)
    )) < 1e-6)
})

test_that("Check Step 3 Standard Errors", {
    expect_true(sum(abs(
        Step3.StandardErrors - c(0.0911189388112166, 0.0989362930080837, 0.0752823800919433,
                                 0.0762344352101995, 0.0677379903135499, 2.95115870810592, 0.101408603083877,
                                 0.0848134252756148, 0.0657518936873182)
    )) < 1e-6)
})
